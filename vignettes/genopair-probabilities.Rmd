---
title: "Genopair Probabilities"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{genopair-probabilities}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ckutils)
```

The conditional probability of observing a pair of genotypes (genopair) given that the animals have a particular family relationship (kinship) can be used to draw inferences about the true kinship between them. In close-kin models those inferences are used together with the probability of observing a pair of animals with a particular family relationship (kinpair) to draw inferences about the population dynamics and demographics parameters of interest.

ckutils provides functions to compute genopair probabilities given a particular kinship between the animals. It assumes that the genotypes are biallelic, having two alleles at each locus, where one was inherited from each parent. 

## How kinship-conditional probabilities of observed genopairs are computed 

At a locus with $l$ possible alleles, there are then $l$ possible homozygous genotypes, where the two alleles are the same, and ${l \choose 2} = l (l - 1) / 2$ heterozygous genotypes, where the two alleles are different, for a total of $g_t := l (l + 1) / 2$ possible genotypes, and $g_p := g_t^2 \approx l^4 / 4$ possible genopairs. 

For a set of $n$ animals there are $n_p := {n \choose 2} = n (n - 1) / 2 \approx n^2 / 2$ pairs, so $n > \approx l^2 / 2 \implies n^2 / 2 > \approx l^4 / 4 \implies n_p > \approx g_p$ and it is likely to be faster to compute the probabilities for all possible genopairs, and look them up for each observed genopair, than to compute them independently.  

## Finding possible kinship-conditional genopair probabilities

The probability of a homozygous genotype $aa$ is approximated by $\mathcal{P}(aa) \approx p_a^2$, where $p_a$ is the relative frequency of allele $a$ in the set of genotypes being analysed.  The probability of a heterozygous genotype $ab$ is approximated by $\mathcal{P}(ab) \approx 2 p_a p_b$, where the factor of two accounts for the two ways that the genotype may have been inherited from the parents. The kinship-conditional probability of a genopair is the probability of the first genotype multiplied by the conditional pobability of the second genotype given the first and the kinship between the animals.


```{r}
# Load a single simulated study and associated parameters
load("../data/single_study.RData")

# Get genotypes for sampled animals
gts = attributes(pop_study)$ind.gts
gts[, 1:10, 1:2]

# Find allele frequencies
ale_frqs = find_ale_frqs(gts)
dfr2(ale_frqs[, 1:10])

# Find possible genotype probabilities
pss_gt_prbs = find_pss_gt_prbs(ale_frqs)
dfr2(pss_gt_prbs[, 1:10])

# Set number of possible genotypes to allow for more later
n_pss_gts = 3

# Set genotype names
gt_names = c("GT00", "GT01", "GT11")

# Set genopair matrix row and column-names
gnpr_names = list(first_genotype = gt_names, second_genotype = gt_names)

# Set genopair probability array dimension names
pfgps_dimnames = c(gnpr_names, list(locus = colnames(gts)))

# Find possible first genotype probabilities for genopairs
pss_frst_gt_prbs = find_pss_frst_gt_prbs(pss_gt_prbs, L)
dfr2(pss_frst_gt_prbs[, , 1])

# Find possible genopair probabilities for unrelated pairs
pss_gp_prbs_ups = find_pss_gp_prbs_ups(pss_frst_gt_prbs)
dfr2(pss_gp_prbs_ups[, , 1])

# Find possible genopair probabilities for parent-offspring pairs
pss_gp_prbs_pops = find_pss_gp_prbs_pops(ale_frqs, L, pss_frst_gt_prbs)
dfr2(pss_gp_prbs_pops[, , 1])

# Find possible genopair probabilities for self pairs
pss_gp_prbs_sps = find_pss_gp_prbs_sps(pss_frst_gt_prbs, L)
dfr2(pss_gp_prbs_sps[, , 1])

# Find possible genopair probabilities for half-sibling pairs
pss_gp_prbs_hsps = find_pss_gp_prbs_hsps(pss_gp_prbs_ups, pss_gp_prbs_pops)
dfr2(pss_gp_prbs_hsps[, , 1])

# Set number of possible genotypes to allow for more later
n_pss_gts = 3

# Combine and save genopair probabilities for selected kinships
pgps = array(
  c(pss_gp_prbs_ups, pss_gp_prbs_hsps, pss_gp_prbs_pops, pss_gp_prbs_sps),
  dim = c(n_pss_gts, n_pss_gts, L, 4),
  dimnames = c(pfgps_dimnames, list(kinship = c("UP", "HSP", "POP", "SP")))
)
save(pgps, file = "../data/possible_genopair_probabilities.RData")
```

## Finding observed kinship-conditional genopair probabilities

```{r}
# Sample histories
smpl_hsts = as.matrix(pop_study[, 4:(3 + k)])

# # Sample genotypes
# smpl_gts = find_smpl_gts(smpl_hsts = smpl_hsts, indl_gts = gts)
# dim(gts)
# dim(smpl_gts)

# Sample-individual indices
siis = row(smpl_hsts)[as.logical(smpl_hsts)]

# Sample-individual index-pairs, n_pairs x 2
siips = t(combn(siis, 2))

# # Find and save observed genopair probabilities, ~10 seconds for current 
# # example
# oglps = find_oglps(pgps = pgps, ind_gts = gts, siips, L)
# save(oglps, file = "../data/observed_genopair_probabilities.RData")

# Load observed genopair probabilities
load(file = "../data/observed_genopair_probabilities.RData")
dfr2(head(oglps))
```
```{r}
# Try to plot for each kinship
dat = lapply(1:4, function(i) {
  # If any log-probabilities greater than negative infinity
  if(any(is.finite(oglps[, i]))) {
    # Plot them
    hist(
      oglps[, i], main = colnames(oglps)[i], xlab = "Log-probability", br = 50
    )
  }
  
  # Otherwise leave a blank plot
  else plot.new()
})
```


